{# jinja2 file itself is NOT auto generated. -#}
// THIS FILE IS AUTOGENERATED. DO NOT EDIT.
// NOLINTBEGIN
// Build target:
// {{build_target}}

#include <string>

#include "py/koladata/serving/serialized_slices.h"
#include "koladata/serving/slice_registry.h"
#include "absl/base/no_destructor.h"
#include "absl/container/flat_hash_map.h"
#include "absl/status/statusor.h"
#include "absl/strings/string_view.h"
#include "koladata/data_slice.h"
#include "arolla/util/init_arolla.h"

{% for n in namespaces %}
namespace {{n}} {
{%- endfor %}

absl::StatusOr<::koladata::DataSlice>
{{function_name}}(absl::string_view name) {
{%- if dynamic_reload %}
  static absl::NoDestructor<::koladata::serving::RunfilesSliceLoader>
      loader(/*filename=*/"{{ serialized_slices }}");
  return loader->GetOrReloadSliceByName(name);
{%- else %}
  constexpr absl::string_view data(
      "{{ serialized_slices | cescape }}",  // golden_test:ignore
      {{ serialized_slices | count }});  // golden_test:ignore
  using SliceMapOrStatus =
      absl::StatusOr<absl::flat_hash_map<std::string, ::koladata::DataSlice>>;
  static const absl::NoDestructor slices([data]() -> SliceMapOrStatus {
    ASSIGN_OR_RETURN(
        auto slices, ::koladata::serving::ParseSerializedSlices(data));
    for (const auto& [k, v] : slices) {
      RETURN_IF_ERROR(::koladata::serving::RegisterSlice(
          absl::StrCat("{{ build_target }}@", k), v));
    }
    return slices;
  }());
  RETURN_IF_ERROR(slices->status());
  return ::koladata::serving::GetSliceByName(**slices, name);
{%- endif %}
}

{%- if not dynamic_reload and slice_names %}
AROLLA_INITIALIZER(
    .name = "{{build_target}}",
    .deps = {
        ::arolla::initializer_dep::kOperators,
        ::arolla::initializer_dep::kS11n,
    },
    .init_fn = []() -> absl::Status {
      // Trigger initialization and ::koladata::serving::RegisterSlice
      return {{function_name}}("{{ slice_names[0] }}").status();
    });
{%- endif %}

{%- for n in namespaces %}
}  // namespace {{n}}
{%- endfor %}
// NOLINTEND

{# end of template #}
